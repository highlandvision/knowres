"use strict";async function findGuest(email){let formData=new FormData;formData.append("email",email);const response=await fetch("index.php?option=com_knowres&task=guests.guestdetails",{method:"post",body:formData});return response.json()}"undefined"!=typeof jQuery&&jQuery.noConflict(),function($){let myBooking=!1,self,$bookPicker,settings={initial:0,pid:0,blocked:[],arrival:"",departure:"",aDate:"",dDate:"",minDate:"",maxDate:"",today:"",editId:0,hideme:1};class KRbooking{constructor($element,options){this.settings=settings,options&&$.extend(this.settings,options),this.init()}static isItAvailable(thisDate,settings){var aDate=settings.aDate,dDate=settings.dDate;if(aDate&&dDate&&aDate<=thisDate&&thisDate<=dDate)return[!0,"dp-highlight"];let value;return 0===(value=void 0!==settings.blocked[thisDate]?settings.blocked[thisDate]:-1)||3===value?[!1,"datepick-booked"]:1===value?[!1,"datepick-booked datepick-candepart"]:2===value?[!0,"datepick-booked datepick-canarrive"]:[!0,""]}static isItAvailableDepart(thisDate,settings){var aDate=settings.aDate,dDate=settings.dDate,maxDate=settings.maxDate;if(thisDate<aDate)return[!1,"datepick-disabled"];if(aDate<=thisDate&&thisDate<=dDate)return[!0,"datepick-selected"];if(maxDate<thisDate)return[!1,"datepick-disabled"];let value;return 0===(value=void 0!==settings.blocked[thisDate]?settings.blocked[thisDate]:-1)||3===value?[!1,""]:2===value?[!1,"datepick-booked datepick-canarrive"]:1===value?[!0,"datepick-booked datepick-candepart"]:[!0,""]}getQuote($this){let data=new FormData($("#contract-form")[0]);data.append("jform[initial]",this.settings.initial),this.settings.initial=0,"manual"===$this.data("override")?data.append("jform[manual]","1"):data.append("jform[manual]","0"),self.settings=this.settings,$.ajax({type:"POST",enctype:"multipart/form-data",url:"index.php?option=com_knowres&task="+$("#task").val(),data:data,processData:!1,contentType:!1,cache:!1,dataType:"json",success:function(result){if(self.settings.hideme=1,$(".hideinitial").show(),result.success){let div,warning=($("#system-message-container").html(""),void 0!==result.data&&null!==result.data&&$.each(result.data.response,function(field,val){field=String(field),val=String(val),div="#jform_"+field,$(div).length&&("jform_expiry_days"===field?$(div).val(val).trigger("liszt:updated"):($(div).text(val),$(div).html(val),$(div).val(val),$(div).show()))}),$("#jform_ajax_warning"));0===warning.text().length?warning.css("display","none"):warning.css("display","block")}else result.messages?Joomla.renderMessages(result.messages):($("#errorModalMessage").empty().append(result.message),$("#errorModal").modal("show"))},error:function(){alert("Sorry an error has occurred, please try again")}})}hasBeenSelected(dateText,$dp,settings){var split=dateText.split("-"),year=split[0],month=split[1],split=split[2];let $depart;year=$.datepicker.formatDate("d M yy",new Date(year,month-1,split));if(!settings.aDate||settings.dDate){$("#arrival").val(dateText),$("#jform_arrival_bd").val(year),($depart=$("#jform_departure_bd")).val(""),$dp.datepicker(),settings.aDate=dateText,settings.dDate="";let found=!(settings.maxDate="2099-12-31");$.each(settings.blocked,function(date,type){return date<settings.aDate||(date>settings.aDate&&date<settings.maxDate&&!found&&(settings.maxDate=date,found=!0),date>settings.maxDate&&1!==type?(settings.maxDate=date,!1):void 0)}),$("#departure").val(settings.maxDate),$depart.datepicker("option","maxDate",settings.maxDate).datepicker("setDate",$.datepicker.formatDate("d M yy",new Date(settings.maxDate))).datepicker("refresh")}else dateText<settings.aDate?($("#jform_departure_bd").val($("jform_arrival_bd").val()),$("#jform_arrival_bd").val(dateText),$dp.datepicker(),settings.dDate=""):($("#jform_departure_bd").val(year),$dp.datepicker(),settings.dDate=dateText,$("#departure").val(dateText).trigger("change"))}init(){self=this,$.ajax({type:"POST",url:"index.php?option=com_knowres&task=contract.init",dataType:"json",data:{pid:self.settings.pid,edit_id:self.settings.editId,arrival:self.settings.arrival,departure:self.settings.departure},success:function(result){if(result.success){self.settings.editId&&(self.settings.initial=1);try{self.settings.blocked=JSON.parse(result.data.blocked)}catch(e){self.settings.blocked=[]}self.settings.arrival||(self.settings.arrival=result.data.arrival,self.settings.departure=result.data.departure,$("#arrival").val(result.data.arrival),$("#jform_arrival_bd").val(result.data.arrival_bd),$("#departure").val(result.data.departure),$("#jform_departure_bd").val(result.data.departure_bd)),self.settings.aDate=self.settings.arrival,self.settings.dDate=self.settings.departure,self.triggerPicker(self),result.data.getquote&&(self.settings.hideme=0,self.getQuote($(".kr-calculate")))}}})}submitPost(form,url){$.ajax({type:"POST",url:url,data:form.serialize(),dataType:"json",success:function(result){result.success?window.location.href=result.data.redirect:result.messages?Joomla.renderMessages(result.messages):($("#errorModalMessage").empty().append(result.message),$("#errorModal").modal("show"))}})}triggerPicker(self){let min=0;self.settings.aDate<self.settings.today?(parts=self.settings.aDate.split("-"),self.settings.minDate=this.settings.aDate,min=new Date(parts[0],parts[1]-1,parts[2])):self.settings.minDate=this.settings.today,$bookPicker=$("#book-datepicker");const $container=$("#container-datepicker");var parts=$container.width();let max=5;parts<600?max=2:600<=parts&&parts<800?max=3:800<=parts&&parts<1e3&&(max=4),$bookPicker.datepicker({minDate:min,maxDate:self.settings.maxDate,numberOfMonths:max,defaultDate:self.settings.aDate,dateFormat:"yy-mm-dd",firstDay:1,beforeShowDay:function(d){d=$.datepicker.formatDate("yy-mm-dd",new Date(d));return d<settings.minDate?[!1,"datepick-disabled"]:!settings.aDate||settings.dDate?KRbooking.isItAvailable(d,settings):d===settings.aDate?[!1,"dp-highlight"]:d<settings.aDate?[!1,"datepick-disabled"]:KRbooking.isItAvailableDepart(d,settings)},onSelect:function(dateText){self.hasBeenSelected(dateText,$bookPicker,self.settings)}}),$bookPicker.width(parts)}}$(function(){const $init=$("#kr-manager-book");$init.length&&(options={pid:$init.data("pid"),today:$init.data("today"),arrival:$init.data("arrival"),departure:$init.data("departure"),editId:$init.data("editid"),minDate:$init.data("today"),maxDate:$init.data("maxdate")},myBooking=new KRbooking($init,options));let go=!0;var options=$("#jform_agent_value");options.length&&""===options.value&&(go=!1);const $quote=$(".kr-calculate"),$apply=($quote.on("change",function(e){e.preventDefault(),myBooking&&go&&myBooking.getQuote($(this))}),$(".btn.kr-calculate"));$apply.on("click",function(e){e.preventDefault(),myBooking&&go&&myBooking.getQuote($(this))}),$(".kr-ajax-form").on("click",function(e){e.preventDefault();const form=$(this);e=form.attr("action");myBooking&&myBooking.submitPost(form,e)})})}(jQuery),document.addEventListener("DOMContentLoaded",function(){document.getElementById("jform_email").addEventListener("blur",()=>{var firstname=document.getElementById("jform_firstname"),email=document.getElementById("jform_email");let formdiv;email.value&&!firstname.value&&findGuest(email.value).then(response=>{if(response.data.found){const keys=Object.keys(response.data.item);keys.forEach(field=>{(formdiv=document.getElementById("jform_"+field))&&(formdiv.value=response.data.item[field],"country_id"===field&&comboGeo(response.data.item[field],"guest.combo","region",response.data.item.region_id))})}})})},!1);