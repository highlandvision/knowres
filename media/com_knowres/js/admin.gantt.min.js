"undefined"==typeof jQuery&&jQuery.noConflict(),function($){let myGantt,scrollTo,ui_aDate,ui_dDate,ui_eDate,ui_minDays,ui_booked;class KrGantt{constructor($element,options){this.settings={source:[],months:["January","February","March","April","May","June","July","August","September","October","November","December"],dow:["Su","Mo","Tu","We","Th","Fr","Sa"],dowClass:["sn","wd","wd","wd","wd","wd","sa"],waitText:"Please wait...",noResults:"Sorry no results found ....",width:600,cellHeight:50,cellWidth:30,popOver:!0,from:KrGantt.getToday(),properties:[]},this.ganttdata={booked:[],options:[]},options&&$.extend(this.settings,options),this.element=$element,this.setSource()}static dateToYmd(date){let month=date.getMonth()+1,day=date.getDate();return month<10&&(month="0"+month),day<10&&(day="0"+day),[date.getFullYear(),month,day].join("-")}static diffDays(date1,date2){const dt1=new Date(date1),dt2=new Date(date2);return Math.floor((Date.UTC(dt2.getFullYear(),dt2.getMonth(),dt2.getDate())-Date.UTC(dt1.getFullYear(),dt1.getMonth(),dt1.getDate()))/864e5)}static getShowFrom(date){let from=new Date(date);return from.setHours(0,0,0),from}static getToday(){return KrGantt.dateToYmd(new Date)}static nameRow(name){return $('<div class="grow name"><div class="cell">'+name+"</div></div>")}static parseDateRange(from,to){let dates=[],start=new Date(from);for(var end=new Date(to);start<=end;)dates.push(new Date(start)),start.setDate(start.getDate()+1);return dates}static propertyPanel(width){return $('<div class="propertyPanel" style="width: '+width+'px;">')}static toArray(data){return data=data.includes(",")?(data=data.split(",")).map(str=>Number(str)):[Number(data)]}static waitToggle(show){show||$(".fn-gantt-loader").hide()}createProgressBar(days,bID,barclass,label,arrivebefore,leaveafter){days=days*this.settings.cellWidth-2;const bar=$("<div class='bar' data-bs-original-title=''><p>"+label+"</p></div>").addClass(barclass).addClass(arrivebefore).addClass(leaveafter).css({width:days});return bar.click(function(e){e.preventDefault();let block="ganttGrey"===barclass?"i":"c";$.ajax({type:"POST",url:"index.php?option=com_knowres&task=contract.modalshow",data:{id:bID,block:block},dataType:"json",success:function(result){$("#kr-gantt-modal-show .modal-content").empty().append(result.data.html).draggable({handle:".modal-header"}),$("#kr-gantt-modal-show").modal("show"),$("#kr-gantt-tab").tab()},error:function(){KrGantt.waitToggle(!1),$("#ganttselections").html("Sorry we cannot process your request at the moment. Please try again later!")}})}),"ganttBook"!==barclass&&"ganttProv"!==barclass||bar.hover(function(e){e.preventDefault(),bar.attr("data-bs-original-title")?bar.popover("toggle"):$.ajax({type:"POST",url:"index.php?option=com_knowres&task=gantt.tooltip",data:{id:bID},dataType:"html",success:function(data){bar.attr("data-bs-container","body"),bar.attr("data-bs-content",data),bar.attr("data-bs-html",!0),bar.attr("data-bs-title",label),bar.attr("data-bs-toggle","popover"),bar.attr("data-bs-trigger","manual"),bar.popover("toggle")}})}),bar}createSearchSelection(data){const selection=$("<a href='#' data-id="+data.id+"><i class='fas fa-times'></i> "+data.name+"</a>").addClass("remove"),self=this;return selection.click(function(e){e.preventDefault();var e=$(this).data("id").toString(),removals=KrGantt.toArray(e);for(let property=0;property<=removals.length;property++)for(let i=self.settings.properties.length-1;0<=i;i--)if(parseInt(self.settings.properties[i])===parseInt(removals[property])){self.settings.properties.splice(i,1);break}$(this).remove(),self.renderChart()}),selection}dataPanel(range){const months=$('<div class="grow">');let dowStr="",year=range[0].getFullYear(),daysInMonth=0,month=range[0].getMonth(),days=range.length;for(let i=0;i<range.length;i++){const rday=range[i];rday.getMonth()!==month&&(months.append($('<div class="cell gheader month" style="width:'+this.settings.cellWidth*daysInMonth+'px;"><div class="gantt-label">'+this.settings.months[month]+" "+year+"</div></div>")),month=rday.getMonth(),days-=daysInMonth,daysInMonth=0),rday.getFullYear()!==year&&(year=rday.getFullYear()),daysInMonth++;var getDay=rday.getDay(),dayClass=this.settings.dowClass[rday.getDay()];dowStr+='<div class="cell day head '+dayClass+'"> <div class="gantt-label">'+this.settings.dow[getDay]+"<br>"+rday.getDate()+"</div></div>"}var lastwidth=this.settings.cellWidth*days-5;return months.append('<div class="cell gheader month" style="width:'+lastwidth+'px;"><div class="gantt-label">'+this.settings.months[month]+" "+year+"</div></div>"),$('<div class="dataPanel"></div>').append(months).append($('<div class="grow">').html(dowStr))}fillData(properties,showFrom,showTo){const self=this;let bar,dl,start,end,$cell,carrive,cdepart,arrivebefore,leaveafter;$.each(this.ganttdata.booked,function(i,entry){properties.length&&-1===$.inArray(entry.id,properties)||$.each(entry.values,function(j,day){if(!(day.arrive>showTo||day.depart<showFrom)){for(end=new Date(day.depart),start=new Date(day.arrive),dl=day.days,arrivebefore="",leaveafter="",carrive=day.arrive,cdepart=day.depart;start<end;)($cell=$("#d"+i+"-"+KrGantt.dateToYmd(start))).hasClass("bookme")&&$cell.removeClass("bookme"),start.setDate(start.getDate()+1);carrive<showFrom&&cdepart>showTo?(dl+=2,carrive=showFrom,arrivebefore="arrivebefore",leaveafter="leaveafter"):carrive<showFrom?(dl=KrGantt.diffDays(showFrom,cdepart)+1,carrive=showFrom,arrivebefore="arrivebefore"):cdepart>showTo&&(dl=KrGantt.diffDays(carrive,showTo)+1,leaveafter="leaveafter"),bar=self.createProgressBar(dl,day.id||"",day.customClass,day.label,arrivebefore,leaveafter),($cell=$("#d"+i+"-"+carrive)).append(bar)}})})}getShowTo(from){var days=Math.floor(this.settings.width/this.settings.cellWidth)-1;let to=new Date(from);return to.setDate(to.getDate()+days),KrGantt.dateToYmd(to)}renderChart(from=null,properties=[]){if(KrGantt.waitToggle(!0),null!==localStorage.getItem("ganttFrom")){from=localStorage.getItem("ganttFrom"),properties=[],localStorage.getItem("ganttProperties")&&(properties=KrGantt.toArray(localStorage.getItem("ganttProperties"))),scrollTo=localStorage.getItem("ganttScrollTo"),$("#ganttselections").html(localStorage.getItem("ganttSelections"));const $picker1=$("#ganttpicker1");var tmp=KrGantt.getShowFrom(from),altDate=$.datepicker.formatDate("yy-mm-dd",tmp),altDate=($picker1.val(altDate),$.datepicker.formatDate("d M yy",tmp));$("#ganttpicker").val(altDate),localStorage.removeItem("ganttFrom"),localStorage.removeItem("ganttProperties"),localStorage.removeItem("ganttGanttScrollTo"),localStorage.removeItem("ganttSelections")}null!==from&&(this.settings.from=from),0!==properties.length&&(this.settings.properties=properties);tmp=this.getShowTo(this.settings.from),altDate=KrGantt.parseDateRange(this.settings.from,tmp);let content=$('<div class="fn-content">');from=this.dataPanel(altDate),content.append(from),properties=this.rightPanel(altDate,this.settings.properties);content.append(properties),this.element.gantt=$('<div class="fn-gantt">').append(content),$(this.element).html(this.element.gantt),this.fillData(this.settings.properties,this.settings.from,tmp),$(this.element).css({height:$(this.element).find(".fn-gantt").height()+"px"}),scrollTo&&($(".rightPanel").scrollTop(scrollTo),scrollTo=0),KrGantt.waitToggle(!1)}rightPanel(range,properties){let day=range[0],propertyPanel=KrGantt.propertyPanel(range.length*this.settings.cellWidth);var entry,todayCls,arrival;let dRow;var today=KrGantt.getToday();for(let i=0;i<this.ganttdata.booked.length;i++)if(entry=this.ganttdata.booked[i],!properties.length||-1!==$.inArray(entry.id,properties)){dRow='<div class="grow">';for(let x=0;x<range.length;x++)day=range[x],arrival=KrGantt.dateToYmd(day),todayCls=this.settings.dowClass[day.getDay()],today<=arrival&&entry.bookme?dRow+='<div class="cell day bookme '+todayCls+'" data-arrival="'+arrival+'" data-id="'+entry.id+'" id="d'+i+"-"+arrival+'"></div>':dRow+='<div class="cell day '+todayCls+'" data-arrival="'+arrival+'"  data-id="'+entry.id+'" id="d'+i+"-"+arrival+'"></div>';propertyPanel.append(KrGantt.nameRow(entry.name)),propertyPanel.append($(dRow+"</div>"))}return $('<div class="rightPanel"></div>').append(propertyPanel)}searchOptions(){const ganttsearch=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.obj.whitespace("name"),queryTokenizer:Bloodhound.tokenizers.whitespace,local:this.ganttdata.options}),self=(ganttsearch.initialize(),this);$(".typeahead").typeahead({minLength:2,highlight:!0},{name:"ganttsearch",source:ganttsearch.ttAdapter(),limit:10,displayKey:"name",templates:{suggestion:function(ganttsearch){return"property"===ganttsearch.type?'<div><a href="javascript:void(0)"><i class="'+ganttsearch.icon+'">&nbsp;</i>'+ganttsearch.name+"<br><span>"+ganttsearch.region+"</span></a></div>":"guest"===ganttsearch.type?'<div><a href="javascript:void(0)"><i class="'+ganttsearch.icon+'">&nbsp;</i>'+ganttsearch.name+"<br><span>"+ganttsearch.property_name+" "+ganttsearch.arrival+"</span></a></div>":"region"===ganttsearch.type?'<div><a href="javascript:void(0)"><i class="'+ganttsearch.icon+'">&nbsp;</i>'+ganttsearch.name+"<br><span>All Properties</span></a></div>":void 0},empty:function(){return"<div>"+self.settings.noResults+"</div>"}}}).on("typeahead:selected",function(e,datum){let $tracker=$("#ganttselections");"property"===datum.type?(self.settings.properties.length?self.settings.properties.push(datum.id):self.settings.properties=[datum.id],$tracker.append(self.createSearchSelection(datum)),self.renderChart()):"guest"===datum.type?($(".uicalendar").datepicker("setDate",datum.arrival),self.renderChart(datum.arrival_ymd),self.modalShow(datum.id)):"region"===datum.type&&(self.settings.properties.length?self.settings.properties=self.settings.properties.concat(datum.id):self.settings.properties=datum.id,$tracker.append(self.createSearchSelection(datum)),self.renderChart()),$(this).typeahead("val","")}),self.renderChart()}setSource(){let self=this;var token=$("#token").attr("name");$.ajax({url:this.settings.source,type:"POST",dataType:"json",data:{[token]:"1"},success:function(result){result.success?(self.ganttdata.booked=result.data.booked,self.ganttdata.options=result.data.options,self.searchOptions()):(KrGantt.waitToggle(!1),$("#ganttselections").html(result.message))},error:function(){KrGantt.waitToggle(!1),$("#ganttselections").html("Sorry we cannot process your request at the moment. Please try again later!")}})}modalShow(bID,block="c"){$.ajax({type:"POST",url:"index.php?option=com_knowres&task=contract.modalshow",data:{id:bID,block:block},dataType:"json",success:function(result){result.success&&($("#kr-gantt-modal-show .modal-content").empty().append(result),$("#kr-gantt-modal-show").modal("show"),$("#kr-gantt-tab").tab())},error:function(){KrGantt.waitToggle(!1),$("#ganttselections").html("Sorry we cannot process your request at the moment. Please try again later!")}})}}function getDpDate(element,format){let date;try{date=$.datepicker.parseDate(format,element.value)}catch(error){date=null}return date}function beforeShowDay(date){date=new Date(date);return function(thisDate,aDate,dDate){if(aDate&&dDate&&aDate<=thisDate&&thisDate<=dDate)return[!0,"datepick-selected"];let value;{if(void 0===ui_booked[thisDate])return[!0,""];value=ui_booked[thisDate]}return 0===value||3===value?[!1,"datepick-booked"]:1===value?[!1,"datepick-booked datepick-half"]:[!0,"datepick-booked datepick-half135"]}($.datepicker.formatDate("yy-mm-dd",date),ui_aDate,ui_dDate)}function beforeShowDayDepart(date){date=new Date(date);return function(thisDate,aDate,dDate){if(aDate&&dDate&&aDate<=thisDate&&thisDate<=dDate)return[!0,"datepick-selected"];if(thisDate>=ui_eDate)return[!1,"datepick-disabled"];let value;{if(void 0===ui_booked[thisDate])return[!0,""];value=ui_booked[thisDate]}return 0===value||3===value?[!1,"datepick-booked"]:1===value?[!0,"datepick-booked datepick-half"]:[!1,"datepick-booked datepick-half135"]}($.datepicker.formatDate("yy-mm-dd",date),ui_aDate,ui_dDate)}$(function(){var params,gantt=$(".kr-gantt");gantt.length&&(params={source:"index.php?option=com_knowres&task=gantt.data",width:Math.floor(document.getElementById("filter-bar").clientWidth)},myGantt=new KrGantt(gantt,params));const $cal=$("#ganttpicker");$cal.length&&$cal.datepicker({altField:"#ganttpicker1",altFormat:"yy-mm-dd",buttonText:'<i class="fas fa-calendar-alt"></i>',changeMonth:!0,changeYear:!0,dateFormat:"d M yy",firstDay:1,maxDate:"+5Y",minDate:"-6M",numberOfMonths:1,selectOtherMonths:!1,showButtonPanel:!0,showOn:"both",showOtherMonths:!1,onSelect:function(dateText,inst){let month=inst.currentMonth+1,day=(month<10&&(month="0"+month),inst.currentDay);inst.currentDay<10&&(day="0"+inst.currentDay);inst=inst.currentYear+"-"+month+"-"+day;scrollTo=$(".rightPanel").scrollTop(),myGantt.renderChart(inst)}}),$(document).on("click",".bookme",function(){const arrival=$(this).data("arrival");let formData=new FormData;formData.append("property_id",$(this).data("id")),formData.append("arrival",$(this).data("arrival")),formData.append("source","gantt"),localStorage.setItem("ganttProperties",myGantt.settings.properties),localStorage.setItem("ganttFrom",myGantt.settings.from),localStorage.setItem("ganttScrollTo",$(".rightPanel").scrollTop()),localStorage.setItem("ganttSelections",$("#ganttselections").html()),$.ajax({url:"index.php?option=com_knowres&task=contract.modalbook",dataType:"json",method:"post",cache:!1,contentType:!1,processData:!1,data:formData,success:function(result){if(result.success){ui_aDate=result.data.ui_aDate,ui_dDate=result.data.ui_dDate,ui_eDate=result.data.ui_eDate,ui_minDays=result.data.ui_minDays;try{ui_booked=JSON.parse(result.data.ui_booked)}catch(e){ui_booked=[]}$("#kr-gantt-modal-book .modal-content").empty().append(result.data.html).draggable({handle:".modal-header"}),$("#kr-gantt-modal-book").modal("show"),$("#kr-gantt-tab").tab();const $from=$("#jform_arrivaldsp").datepicker({altField:"#arrival",altFormat:"yy-mm-dd",buttonText:'<i aria-label="Select date" class="fas fa-calendar-alt"></i>',changeMonth:!0,changeYear:!0,dateFormat:"d M yy",defaultDate:arrival,minDate:ui_minDays,numberOfMonths:1,selectOtherMonths:!0,showOn:"both",showOtherMonths:!0,beforeShowDay:beforeShowDay}).on("change",function(){ui_aDate=$.datepicker.formatDate("yy-mm-dd",new Date($(this).val())),$to.datepicker("option","minDate",getDpDate(this,"mm/dd/yy"));let new2=$("#jform_arrivaldsp").datepicker("getDate","+1d");new2.setDate(new2.getDate()+1),$("#jform_departuredsp").datepicker("setDate",new2),ui_dDate=$.datepicker.formatDate("yy-mm-dd",new Date(new2)),$("#kr-gantt-book-modal #arrival").val(ui_aDate)}),$to=$("#jform_departuredsp").datepicker({altField:"#departure",altFormat:"yy-mm-dd",buttonText:'<i class="fas fa-calendar-alt"></i>',changeMonth:!0,changeYear:!0,defaultDate:"+1d",dateFormat:"d M yy",numberOfMonths:1,showOn:"both",selectOtherMonths:!0,showOtherMonths:!0,beforeShowDay:beforeShowDayDepart}).on("change",function(){ui_dDate=$.datepicker.formatDate("yy-mm-dd",new Date($(this).val())),$from.datepicker("option","maxDate",getDpDate(this,"mm/dd/yy")),$("#kr-gantt-book-modal #departure").val(ui_dDate)})}},error:function(){KrGantt.waitToggle(!1),$("#ganttselections").html("Sorry we cannot process your request at the moment. Please try again later!")}})}).on("click","#newreservation",function(e){e.preventDefault();e=$(this).attr("href")+"&property_id="+$(this).data("id")+"&arrival="+$("#arrival").val()+"&departure="+$("#departure").val();window.location.replace(e)}).on("click",".modalshowcancel",function(e){e.preventDefault();e=$(this).data("id");localStorage.setItem("ganttProperties",myGantt.settings.properties),localStorage.setItem("ganttFrom",myGantt.settings.from),localStorage.setItem("ganttScrollTo",$(".rightPanel").scrollTop()),$.ajax({type:"POST",dataType:"json",url:"index.php?option=com_knowres&task="+$(this).data("task"),data:{id:e},success:function(result){result.success?window.location.reload():alert(result.message)}})}),$(".ganttchange").on("click",function(e){e.preventDefault();const $picker1=$("#ganttpicker1");e=$(this).data("direction");let from;from=e?(days=Math.floor(myGantt.settings.width/30)-1,(from=new Date($picker1.val())).setHours(0,0,0),"left"===e?new Date(from.setDate(from.getDate()-days)):new Date(from.setDate(from.getDate()+days))):new Date,scrollTo=$(".rightPanel").scrollTop(),myGantt.renderChart(KrGantt.dateToYmd(from));var e=$.datepicker.formatDate("yy-mm-dd",from),days=($picker1.val(e),$.datepicker.formatDate("d M yy",from));$("#ganttpicker").val(days)})})}(jQuery);